### 2.1 C# 동적 컴파일
---
- 런타임으로 C# 코드 텍스트를 컴파일해서 .EXE 나 .DLL 등으로 빌드할 수 있다.
- ***CreateProvider*** 메서드로 특정 언어에 대한 컴파일러 오브젝트를 생성한 후,
- ***CompileAssemblyFromSource*** 메서드로 빌드하면 된다.
- 이 외에 파일로부터 컴파일하는 ***CompileAssemblyFromFile***
- DOM 트리로부터 컴파일하는 ***CompileAssemblyFromDom*** 등이 있다.
    ```
    using System;
    using System.CodeDom.Compiler;
    using System.Diagnostics;

    class Program
    {
        static void Main(string[] args)
        {
            string code = """
                using System;
                namespace TEST
                {
                    class Program
                    {
                        static void Main(string[] args)
                        {
                            int sum = 0;
                            for (int i = 0; i < 100; i++)
                                sum += i;
            
                            Console.WriteLine(sum);
                            Console.ReadLine();
                        }
                    }
                }
                """;

            var codeDom = CodeDomProvider.CreateProvider("CSharp");
            var results = codeDom.CompileAssemblyFromSource
            (
                new CompilerParameters()
                {
                    GenerateExecutable = true,
                    OutputAssembly = "TEST.EXE"
                },
                code
            );

            if (results.Errors.Count > 0)
            {
                foreach (var err in results.Errors)
                    Console.WriteLine(err.ToString());
                return;
            }

            Process.Start("TEST.EXE");
        }
    }
    ```
- ***See Also**
    - [***C# 동적 컴파일***](http://www.csharpstudy.com/Practical/Prac-dynamic-compile.aspx)


　

### 2.2 동적 CLASS 생성과 사용 #1
---
- 문자열로부터 C# 클래스를 생성하여 메모리 상에 올려놓고,
- 이 클래스로부터 오브젝트 인스턴스를 생성하고 그 속성과 메서드를 .NET Reflection을 통해 사용할 수 있다.
- VB.NET 코드를 컴파일 하려면 "CSharp" 대신에 "VisualBasic"을 지정.
    ```
    using System;
    using System.CodeDom.Compiler;
    using System.Reflection;

    class Program
    {
        static void Main(string[] args)
        {
            string code = """
                using System;
                namespace Test
                {
                    class MyClass
                    {
                        public string Name
                        {
                            get; set;
                        }
                        public void PrintName()
                        {
                            Console.WriteLine(Name);
                        }
                    }
                }
                """;

            var codeDom = CodeDomProvider.CreateProvider("CSharp");
            var results = codeDom.CompileAssemblyFromSource
            (
            new CompilerParameters()
            {
                GenerateInMemory = true,
                //ReferencedAssemblies.Add("ThirdParty.dll")
            },
            code
            );

            if (results.Errors.Count > 0)
            {
                foreach (var err in results.Errors)
                    Console.WriteLine(err.ToString());
                return;
            }

            Type type = results.CompiledAssembly.GetType("Test.MyClass");
            object obj = Activator.CreateInstance(type);
            PropertyInfo pi = obj.GetType().GetProperty("Name");

            pi.SetValue(obj, "Alex", null);
            object name = pi.GetValue(obj);
            Console.WriteLine(name);

            obj.GetType().GetMethod("PrintName").Invoke(obj, null);
        }
    }
    ```
- ***See Also**
    - [***C# 동적 컴파일***](http://www.csharpstudy.com/Practical/Prac-dynamic-compile.aspx)


　

### 2.3 동적 CLASS 생성과 사용 #2
---
- DLL 파일을 빌드하고 직접 로드하여 클래스를 사용할 수 있다.
- 겸사겸사 static 메서드를 어떻게 접근하여 사용하는지 보여준다.
    ```
    using System;
    using System.CodeDom.Compiler;
    using System.Reflection;

    class Program
    {
        static void Main(string[] args)
        {
            string code = """
                using System;
                namespace TEST
                {
                    class Program
                    {
                        static void Test()
                        {
                            int sum = 0;
                            for (int i = 0; i < 100; i++)
                                sum += i;
    
                            Console.WriteLine(sum);
                            Console.ReadLine();
                        }
                    }
                }
                """;

            var codeDom = CodeDomProvider.CreateProvider("CSharp");
            var results = codeDom.CompileAssemblyFromSource
            (
            new CompilerParameters()
            {
                GenerateExecutable = false,
                OutputAssembly = "TEST.DLL"
            },
            code
            );

            if (results.Errors.Count > 0)
            {
                foreach (var err in results.Errors)
                    Console.WriteLine(err.ToString());
                return;
            }

            Assembly
                .LoadFrom("TEST.DLL")
                .GetType("TEST.Program")
                .GetMethod("Test", BindingFlags.NonPublic | BindingFlags.Static)
                .Invoke(null, null);
        }
    }
    ```
- ***See Also**
    - [***C# 동적 컴파일***](http://www.csharpstudy.com/Practical/Prac-dynamic-compile.aspx)


　

### 2.4 코드 텍스트를 바로 로드하여 사용하기
---
- 코드를 원격지에서 다운받아 file IO 없이 바로 사용하는데 응용할 수 있겠다.
    ```
    using System.IO;
    using System.Reflection;
    
    class Program
    {
        static void Main(string[] args)
        {
            Assembly
                .Load(File.ReadAllBytes("TEST.DLL"))
                .GetType("TEST.Program")
                .GetMethod("Test", BindingFlags.NonPublic | BindingFlags.Static)
                .Invoke(null, null);
        }
    }
    ```
- ***See Also***
    - [***Assembly.Load Method***](https://docs.microsoft.com/en-us/dotnet/api/system.reflection.assembly.load?view=netframework-4.8)
    - [***How to: Load Assemblies into an Application Domain***](https://docs.microsoft.com/en-us/dotnet/framework/app-domains/how-to-load-assemblies-into-an-application-domain)
    - [***Best Practices for Assembly Loading***](https://docs.microsoft.com/en-us/dotnet/framework/deployment/best-practices-for-assembly-loading)
    - [***How to: Load and unload assemblies***](https://docs.microsoft.com/en-us/dotnet/standard/assembly/load-unload)
    - [***Loading Assemblies using Assembly.Load, Assembly.LoadFrom and Assembly.LoadFile***](https://www.codeproject.com/Articles/597398/Loading-Assemblies-using-Assemb)
    - [***DLL reload***](https://supercoding.tistory.com/5)


