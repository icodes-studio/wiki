REFLECTION EMIT으로 GENERIC TYPE 만들기
참고: How to: Define a Generic Type with Reflection Emit - .NET Framework

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
using System;
using System.Reflection;
using System.Reflection.Emit;
using System.Collections.Generic;
 
public interface IExampleA { }
public interface IExampleB { }
public class ExampleBase { }
public class ExampleDerived : ExampleBase, IExampleA, IExampleB { }
 
public class Example
{
  public static void Main()
  {
    var type = AppDomain
      .CurrentDomain
      .DefineDynamicAssembly(new AssemblyName("GenericEmitExample"), AssemblyBuilderAccess.Run)
      .DefineDynamicModule("GenericEmitExample")
      .DefineType("Sample", TypeAttributes.Public);
 
    var gp = type.DefineGenericParameters(new string[] { "TFirst", "TSecond" });
    var TFirst = gp[0];
    var TSecond = gp[1];
 
    TFirst.SetGenericParameterAttributes(GenericParameterAttributes.DefaultConstructorConstraint | GenericParameterAttributes.ReferenceTypeConstraint);
    TSecond.SetBaseTypeConstraint(typeof(ExampleBase));
    TSecond.SetInterfaceConstraints(new Type[] { typeof(IExampleA), typeof(IExampleB) });
 
    var field = type.DefineField("ExampleField", TFirst, FieldAttributes.Private);
    var method = type.DefineMethod(
      "ExampleMethod",
      MethodAttributes.Public | MethodAttributes.Static,
      typeof(List<>).MakeGenericType(TFirst),
      new Type[] { TFirst.MakeArrayType() });
 
    var TfromListOf = typeof(List<>).GetGenericArguments()[0];
    var ienumOfT = typeof(IEnumerable<>).MakeGenericType(TfromListOf);
    var ctorPrep = typeof(List<>).GetConstructor(new Type[] { ienumOfT });
    var ctor = TypeBuilder.GetConstructor(typeof(List<>).MakeGenericType(TFirst), ctorPrep);
    var il = method.GetILGenerator();
 
    il.Emit(OpCodes.Ldarg_0);
    il.Emit(OpCodes.Newobj, ctor);
    il.Emit(OpCodes.Ret);
 
    Console.WriteLine(
      "\nThere are {0} elements in the List<Example>.",
      ((List<Example>)type
      .CreateType()
      .MakeGenericType(new Type[] { typeof(Example), typeof(ExampleDerived) })
      .GetMethod("ExampleMethod")
      .Invoke(null, new object[] { new Example[] { new Example(), new Example() } }))
      .Count);
  }
}
　

2. REFLECTION EMIT으로 GENERIC METHOD 만들기
참고: How to: Define a Generic Method with Reflection Emit - .NET Framework

1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
using System;
using System.Reflection;
using System.Reflection.Emit;
using System.Collections.Generic;
 
public class Example
{
  public delegate TOutput FactoryDelegate<TInput, TOutput>(TInput[] input);
 
  public static TOutput Factory<TInput, TOutput>(TInput[] inputs)
    where TOutput : class, ICollection<TInput>, new()
  {
    TOutput ret = new TOutput();
    ICollection<TInput> ic = ret;
 
    foreach (TInput input in inputs)
      ic.Add(input);
 
    return ret;
  }
 
  public static void Main()
  {
    string[] arr = { "a", "b", "c", "d", "e" };
    List<string> list = Example.Factory<string, List<string>>(arr);
    Console.WriteLine("The first element is: {0}", list[0]);
 
    var type = AppDomain
      .CurrentDomain
      .DefineDynamicAssembly(new AssemblyName("DemoMethodBuilder"), AssemblyBuilderAccess.Run)
      .DefineDynamicModule("DemoMethodBuilder")
      .DefineType("DemoType", TypeAttributes.Public);
 
    var method = type.DefineMethod("Factory", MethodAttributes.Public | MethodAttributes.Static);
    var gp = method.DefineGenericParameters(new string[] { "TInput", "TOutput" });
    var TInput = gp[0];
    var TOutput = gp[1];
 
    TOutput.SetGenericParameterAttributes(GenericParameterAttributes.ReferenceTypeConstraint | GenericParameterAttributes.DefaultConstructorConstraint);
    TOutput.SetInterfaceConstraints(new Type[] { typeof(ICollection<>).MakeGenericType(TInput) });
    method.SetParameters(new Type[] { TInput.MakeArrayType() });
    method.SetReturnType(TOutput);
 
    var il = method.GetILGenerator();
    var ret = il.DeclareLocal(TOutput);
    var ic = il.DeclareLocal(typeof(ICollection<>).MakeGenericType(TInput));
    var inputs = il.DeclareLocal(TInput.MakeArrayType());
    var index = il.DeclareLocal(typeof(int));
    var enterLoop = il.DefineLabel();
    var loopAgain = il.DefineLabel();
 
    il.Emit(OpCodes.Ldarg_0);
    il.Emit(OpCodes.Stloc_S, inputs);
    il.Emit(OpCodes.Call, typeof(Activator).GetMethod("CreateInstance", Type.EmptyTypes).MakeGenericMethod(TOutput));
    il.Emit(OpCodes.Stloc_S, ret);
    il.Emit(OpCodes.Ldloc_S, ret);
    il.Emit(OpCodes.Box, TOutput);
    il.Emit(OpCodes.Castclass, typeof(ICollection<>).MakeGenericType(TInput));
    il.Emit(OpCodes.Stloc_S, ic);
    il.Emit(OpCodes.Ldc_I4_0);
    il.Emit(OpCodes.Stloc_S, index);
    il.Emit(OpCodes.Br_S, enterLoop);
    il.MarkLabel(loopAgain);
    il.Emit(OpCodes.Ldloc_S, ic);
    il.Emit(OpCodes.Ldloc_S, inputs);
    il.Emit(OpCodes.Ldloc_S, index);
    il.Emit(OpCodes.Ldelem, TInput);
    il.Emit(OpCodes.Callvirt, TypeBuilder.GetMethod(typeof(ICollection<>).MakeGenericType(TInput), typeof(ICollection<>).GetMethod("Add")));
    il.Emit(OpCodes.Ldloc_S, index);
    il.Emit(OpCodes.Ldc_I4_1);
    il.Emit(OpCodes.Add);
    il.Emit(OpCodes.Stloc_S, index);
    il.MarkLabel(enterLoop);
    il.Emit(OpCodes.Ldloc_S, index);
    il.Emit(OpCodes.Ldloc_S, inputs);
    il.Emit(OpCodes.Ldlen);
    il.Emit(OpCodes.Conv_I4);
    il.Emit(OpCodes.Clt);
    il.Emit(OpCodes.Brtrue_S, loopAgain);
    il.Emit(OpCodes.Ldloc_S, ret);
    il.Emit(OpCodes.Ret);
 
    Console.WriteLine(
      "The first element is: {0}",
      ((List<string>)type
      .CreateType()
      .GetMethod("Factory")
      .MakeGenericMethod(typeof(string), typeof(List<string>))
      .Invoke(null, new object[] { arr }))[0]);
 
    var delegateType = typeof(FactoryDelegate<string, List<string>>);
    var factoryInfo = type.GetMethod("Factory").MakeGenericMethod(typeof(string), typeof(List<string>));
    var factory = (FactoryDelegate<string, List<string>>)Delegate.CreateDelegate(delegateType, factoryInfo);
    Console.WriteLine("The first element is: {0}", factory(arr)[0]);
  }
}
　